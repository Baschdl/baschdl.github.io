<!DOCTYPE html>
<html>
<head>
    <title>Snow cover</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="https://carto.com/favicon.ico"/>
    <style>
        html, body, #map {
            height: 100%;
            padding: 0;
            margin: 0;
        }
    </style>

    <link rel="stylesheet" href="https://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css"/>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700|Open+Sans:300,400,600" rel="stylesheet">
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="https://libs.cartocdn.com/carto.js/v4.2.0/carto.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:600" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link href="https://carto.com/developers/carto-js/examples/maps/public/style.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./slider.css"  />
    <!-- Include gpx.js -->
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css" />
</head>
<body>

<div id="map"></div>
<div class="slidecontainer">
    <input type="range" min="0" max="100" value="20" class="slider" id="opacity">
</div>

<script src="style.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.4.0/gpx.min.js"></script>
<script>

    const dataset = `snow`;

    const snowDataset = new carto.source.Dataset(dataset);
    const snowFilter = new carto.filter.Range('dn', {lte: 100, gte: 100});
    snowDataset.addFilter(snowFilter);

    const noDataDataset = new carto.source.Dataset(dataset);
    const noDataFilter = new carto.filter.Range('dn', {lte: 205, gte: 205});
    noDataDataset.addFilter(noDataFilter);

    var snowLayer;
    var noDataLayer;

    function addBothLayers(opacity, client) {
        const snowStyle = new carto.style.CartoCSS(getSnowStyle(opacity));
        const newSnowLayer = new carto.layer.Layer(snowDataset, snowStyle);

        const noDataStyle = new carto.style.CartoCSS(getNoDataStyle(opacity));
        const newNoDataLayer = new carto.layer.Layer(noDataDataset, noDataStyle);

        client.addLayers([newSnowLayer, newNoDataLayer]);

        snowLayer = newSnowLayer;
        noDataLayer = newNoDataLayer;

    }

    function onChange(opacity, client) {
	client.getLeafletLayer().setOpacity(opacity);
    }


    const map = L.map('map').setView([46.3, 7], 10);

    // Adding Voyager Basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}.png', {
        maxZoom: 18
    }).addTo(map);


    var client = new carto.Client({
        apiKey: 'tc_BZnwzfrkWMeMBfkyF3A',
        username: 'snow',
        serverUrl: 'https://much-snow.is-very-bad.org/user/snow',
    });

    values = addBothLayers(0.2, client);

    client.getLeafletLayer().addTo(map);

    var slider = document.getElementById("opacity");

    slider.oninput = function() {
        onChange(this.value/100, client);
    }


    var lineStyle = {
    "color": "#ff7800",
    "weight": 5,
    "opacity": 0.65
	};


    var gpx = '2020-06-22_207026622_Vouvry-Troistorrents.gpx'; // URL to your GPX file or the GPX itself
    
    new L.GPX(gpx, {async: true, style: lineStyle}).on('loaded', function(e) {
    	  map.fitBounds(e.target.getBounds());
    	}).addTo(map);

    var gpx2 = '2020-06-22_207024886_Vouvry-Martigny.gpx'; // URL to your GPX file or the GPX itself
    
    new L.GPX(gpx2, {async: true}).on('loaded', function(e) {
    	  map.fitBounds(e.target.getBounds());
    	}).addTo(map);

</script>
</body>
</html>
